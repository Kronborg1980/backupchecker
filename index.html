<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KRONBORG COMMAND CENTER v4.0</title>
  <style>
    :root {
      --bg-dark: #050505;
      --glass-panel: rgba(20, 20, 25, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --primary: #00f3ff;
      --accent: #7000ff;
      --success: #00ff9d;
      --danger: #ff0055;
      --text-main: #ffffff;
      --text-muted: #8b9bb4;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(112, 0, 255, 0.15), transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(0, 243, 255, 0.15), transparent 25%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 2rem;
    }

    /* Grid Layout */
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      width: 100%;
      max-width: 1000px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .dashboard { grid-template-columns: 1fr; }
    }

    /* Card Styling */
    .card {
      background: var(--glass-panel);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }

    .full-width { grid-column: 1 / -1; }

    /* Typography */
    h1 {
      font-family: 'Orbitron', monospace;
      font-size: 1.5rem;
      margin: 0 0 5px 0;
      background: linear-gradient(90deg, var(--primary), #fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 1px;
    }
    
    h2 { font-size: 1rem; color: var(--text-muted); margin: 0 0 15px 0; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; font-size: 0.75rem; }

    /* Inputs & Lists */
    .input-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 200px;
      overflow-y: auto;
      padding-right: 5px;
      margin-bottom: 10px;
    }
    
    /* Scrollbar styling */
    .input-list::-webkit-scrollbar { width: 6px; }
    .input-list::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 3px; }

    .input-row { display: flex; gap: 8px; animation: slideIn 0.3s ease; }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    input {
      flex: 1;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--glass-border);
      color: var(--primary);
      padding: 10px 14px;
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      transition: 0.2s;
    }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }

    /* Buttons */
    button {
      border: none;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      transition: 0.2s;
      border-radius: 8px;
    }

    .btn-icon {
      width: 38px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
    }
    .btn-icon:hover { background: rgba(255, 0, 85, 0.2); color: var(--danger); }

    .btn-add {
      background: rgba(0, 243, 255, 0.1);
      color: var(--primary);
      width: 100%;
      padding: 10px;
      font-size: 0.8rem;
      border: 1px dashed rgba(0, 243, 255, 0.3);
    }
    .btn-add:hover { background: rgba(0, 243, 255, 0.2); border-style: solid; }

    .btn-action {
      padding: 16px;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .start { background: linear-gradient(135deg, rgba(0, 243, 255, 0.2), rgba(0, 243, 255, 0.05)); border: 1px solid var(--primary); color: var(--primary); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }
    .start:hover { box-shadow: 0 0 25px rgba(0, 243, 255, 0.4); transform: translateY(-2px); }

    .stop { background: rgba(255, 0, 85, 0.1); border: 1px solid var(--danger); color: var(--danger); }
    .stop:hover { background: rgba(255, 0, 85, 0.2); box-shadow: 0 0 15px rgba(255, 0, 85, 0.4); }

    .test { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 8px 16px; font-size: 0.8rem; }
    .test:hover { border-color: var(--text-main); color: var(--text-main); }

    /* Slider */
    .slider-container { margin-top: 15px; }
    input[type=range] { width: 100%; accent-color: var(--primary); }

    /* Terminal */
    .terminal {
      background: #000;
      border-radius: 8px;
      padding: 15px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: #aaa;
      height: 150px;
      overflow-y: auto;
      border: 1px solid #333;
    }
    .log-time { color: #555; margin-right: 8px; }
    .log-info { color: var(--primary); }
    .log-success { color: var(--success); }
    .log-error { color: var(--danger); }
    .log-warn { color: #ffae00; }

    /* Status Badge */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      margin-left: 10px;
      background: #333;
      color: #777;
    }
    .status-badge.active { background: rgba(0, 255, 157, 0.2); color: var(--success); box-shadow: 0 0 10px rgba(0, 255, 157, 0.2); }
    
    .hidden { display: none !important; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
</head>
<body>

  <div class="dashboard">
    
    <div class="card full-width flex-between">
      <div>
        <h1>KRONBORG COMMAND v4.0</h1>
        <div style="font-size: 0.8rem; color: var(--text-muted);">Target: PokÃ©mon Center TCG</div>
      </div>
      <div class="flex-between" style="gap:10px">
         <div id="sysStatus" class="status-badge">SYSTEM OFFLINE</div>
         <div id="runTimer" style="font-family: 'JetBrains Mono'; font-size: 0.9rem;">00:00:00</div>
      </div>
    </div>

    <div class="card">
      <div class="flex-between">
        <h2>Email Alerts</h2>
        <button class="test" onclick="testEmails()">Test Email</button>
      </div>
      <div id="emailList" class="input-list">
        </div>
      <button class="btn-add" onclick="addEmailRow()">+ Add Email Recipient</button>
    </div>

    <div class="card">
      <div class="flex-between">
        <h2>Discord Webhooks</h2>
        <button class="test" onclick="testWebhooks()">Test Discord</button>
      </div>
      <div id="webhookList" class="input-list">
        </div>
      <button class="btn-add" onclick="addWebhookRow()">+ Add Webhook URL</button>
      <div style="margin-top: 5px; font-size: 0.7rem; color: #555; cursor: pointer; text-align:center" onclick="addPokezonanPreset()">
        Load "Pokezonan" Preset
      </div>
    </div>

    <div class="card full-width">
      <h2>Scan Controls</h2>
      
      <div class="slider-container">
        <div class="flex-between" style="margin-bottom: 5px;">
          <span style="font-size: 0.8rem;">Scan Interval</span>
          <span id="freqDisplay" style="color: var(--primary); font-weight: bold;">10 min</span>
        </div>
        <input type="range" id="freqSlider" min="1" max="60" value="10" oninput="updateFreq(this.value)">
        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;">
          *Includes "Human Jitter" (Â±60s randomization) to prevent detection.
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
        <button id="btnStart" class="btn-action start" onclick="toggleSystem(true)">INITIALIZE SCAN</button>
        <button id="btnStop" class="btn-action stop hidden" onclick="toggleSystem(false)">ABORT SEQUENCE</button>
      </div>
    </div>

    <div class="card full-width">
      <h2>Live System Log</h2>
      <div id="terminal" class="terminal">
        <div class="log-line"><span class="log-time">--:--:--</span>System initialized. Waiting for input...</div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4.4.1/dist/email.min.js"></script>
  <script>
    // --- SETUP ---
    const TARGET_URL = "https://www.pokemoncenter.com/category/trading-card-game";
    const EMAILJS_KEY = "8w7eu6mrg3lRl6ta3"; 
    
    // State
    let isRunning = false;
    let scanTimer = null;
    let clockTimer = null;
    let startTime = 0;
    
    // Init EmailJS
    if(window.emailjs) emailjs.init({ publicKey: EMAILJS_KEY });

    // --- DOM ELEMENTS ---
    const emailList = document.getElementById('emailList');
    const webhookList = document.getElementById('webhookList');
    const terminal = document.getElementById('terminal');
    const sysStatus = document.getElementById('sysStatus');

    // --- INITIALIZATION (Load Saved Data) ---
    window.onload = function() {
        loadSettings();
        if(emailList.children.length === 0) addEmailRow(); // Empty slot
        if(webhookList.children.length === 0) addWebhookRow(); // Empty slot
    }

    // --- UI FUNCTIONS ---

    function createRow(value = '', placeholder, type) {
        const div = document.createElement('div');
        div.className = 'input-row';
        div.innerHTML = `
            <input type="${type}" value="${value}" placeholder="${placeholder}" onchange="saveSettings()">
            <button class="btn-icon" onclick="this.parentElement.remove(); saveSettings();">&times;</button>
        `;
        return div;
    }

    function addEmailRow(val = '') {
        emailList.appendChild(createRow(val, 'name@example.com', 'email'));
    }

    function addWebhookRow(val = '') {
        webhookList.appendChild(createRow(val, 'https://discord.com/api/webhooks/...', 'url'));
    }

    function addPokezonanPreset() {
        addWebhookRow("https://discord.com/api/webhooks/1418654823745716436/vuMKu1s095Cq3BfU06OF_Z_mwxG39zHppHJ3c4BX5X38WuJFWPGhIZdopWTEEXlophiN");
        saveSettings();
        log("Preset: Pokezonan webhook added.", "info");
    }

    function updateFreq(val) {
        document.getElementById('freqDisplay').innerText = val + " min";
    }

    function log(msg, type = "info") {
        const now = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.innerHTML = `<span class="log-time">${now}</span><span class="log-${type}">${msg}</span>`;
        terminal.prepend(line);
        // Keep log clean
        if (terminal.children.length > 50) terminal.lastChild.remove();
    }

    // --- SAVE/LOAD SYSTEM ---
    
    function saveSettings() {
        const emails = Array.from(emailList.querySelectorAll('input')).map(i => i.value);
        const webhooks = Array.from(webhookList.querySelectorAll('input')).map(i => i.value);
        localStorage.setItem('kronborg_emails', JSON.stringify(emails));
        localStorage.setItem('kronborg_webhooks', JSON.stringify(webhooks));
    }

    function loadSettings() {
        const emails = JSON.parse(localStorage.getItem('kronborg_emails') || '[]');
        const webhooks = JSON.parse(localStorage.getItem('kronborg_webhooks') || '[]');
        
        emails.forEach(e => { if(e) addEmailRow(e) });
        webhooks.forEach(w => { if(w) addWebhookRow(w) });
    }

    // --- CORE LOGIC ---

    function toggleSystem(state) {
        isRunning = state;
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');

        if (isRunning) {
            btnStart.classList.add('hidden');
            btnStop.classList.remove('hidden');
            sysStatus.innerText = "SYSTEM ACTIVE";
            sysStatus.classList.add('active');
            startTime = Date.now();
            
            log("Sequence started. Initializing proxy chain...", "info");
            
            // Start Clock
            clockTimer = setInterval(() => {
                const diff = Date.now() - startTime;
                const d = new Date(diff);
                document.getElementById('runTimer').innerText = d.toISOString().substr(11, 8);
            }, 1000);

            runCheckLoop();
        } else {
            btnStart.classList.remove('hidden');
            btnStop.classList.add('hidden');
            sysStatus.innerText = "SYSTEM OFFLINE";
            sysStatus.classList.remove('active');
            clearTimeout(scanTimer);
            clearInterval(clockTimer);
            log("Sequence aborted by user.", "error");
        }
    }

    async function runCheckLoop() {
        if (!isRunning) return;

        await checkShop();

        const baseMins = parseInt(document.getElementById('freqSlider').value);
        const baseMs = baseMins * 60 * 1000;
        const jitter = Math.floor(Math.random() * 60000); // 0-60s random
        const nextTime = baseMs + jitter;

        log(`Sleeping for ${Math.floor(nextTime/1000)}s...`, "info");
        scanTimer = setTimeout(runCheckLoop, nextTime);
    }

    // --- CHECKER LOGIC (v3.0 Logic) ---
    async function checkShop() {
        log("Pinging target via Proxy Rotation...", "info");

        // 1. Setup Proxies
        const ts = Date.now();
        const encoded = encodeURIComponent(TARGET_URL + `?cb=${ts}`);
        const proxies = [
            `https://api.allorigins.win/raw?url=${encoded}`,
            `https://corsproxy.io/?${encoded}`
        ];

        let content = null;
        let finalUrl = "";

        // 2. Fetch
        for (const proxy of proxies) {
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 15000);
                const res = await fetch(proxy, { signal: controller.signal });
                clearTimeout(id);
                
                if (res.ok) {
                    content = (await res.text()).toLowerCase();
                    finalUrl = res.url.toLowerCase();
                    break;
                }
            } catch (e) {}
        }

        if (!content) {
            log("Network Error: Could not reach proxies.", "error");
            return;
        }

        // 3. Analyze
        if (finalUrl.includes("queue-it.net") || content.includes("users in line") || content.includes("queue_id")) {
            log("CRITICAL: QUEUE DETECTED!", "error");
            broadcast("QUEUE ACTIVE!", "You are in a queue. Check immediately.");
            playAlarm();
        } 
        else if (content.includes("add to cart") || content.includes("trading card game")) {
            log("SUCCESS: SHOP ACCESSIBLE!", "success");
            broadcast("DROP LIVE!", "Shop is open and accessible.");
            playAlarm();
        } 
        else if (content.includes("challenge") || content.includes("cloudflare")) {
            log("Soft Block (Cloudflare). Retrying next cycle.", "warn");
        }
        else {
            log("Target reachable. No queue found.", "info");
        }
    }

    // --- BROADCASTING ---

    function broadcast(title, msg) {
        const emails = Array.from(emailList.querySelectorAll('input')).map(i => i.value).filter(v => v.includes('@'));
        const webhooks = Array.from(webhookList.querySelectorAll('input')).map(i => i.value).filter(v => v.includes('http'));

        // Send Discord
        webhooks.forEach(url => {
            const color = title.includes("DROP") ? 5763719 : 15548997;
            fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    embeds: [{
                        title: `ðŸš¨ ${title}`,
                        description: msg,
                        color: color,
                        timestamp: new Date().toISOString()
                    }]
                })
            }).catch(e => log("Discord send failed", "error"));
        });

        // Send Email
        emails.forEach(email => {
            emailjs.send("service_ahqdaj5", "template_whhvnra", {
                status: title,
                details: msg,
                to_email: email
            });
        });
    }

    // --- TESTING ---
    function testEmails() {
        const count = emailList.querySelectorAll('input[value*="@"]').length;
        if(count > 0) {
            broadcast("TEST EMAIL", "If you read this, email alerts are working.");
            log(`Sent test to ${count} emails.`, "success");
        } else {
            alert("Add a valid email first.");
        }
    }

    function testWebhooks() {
        const count = webhookList.querySelectorAll('input[value*="http"]').length;
        if(count > 0) {
            broadcast("TEST DISCORD", "Webhook connection confirmed.");
            log(`Sent test to ${count} webhooks.`, "success");
        } else {
            alert("Add a valid webhook URL first.");
        }
    }

    // Audio
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playAlarm() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(440, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(880, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
    }
  </script>
</body>
</html>
